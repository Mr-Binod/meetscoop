<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ÎèôÌò∏Ìöå ÏÉÅÏÑ∏ÌéòÏù¥ÏßÄ</title>
    <link rel="stylesheet" href="/public/css/club/detail_club.css">
    <link href='https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.css' rel='stylesheet' />
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.js'></script>
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/locales/ko.js'></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
</head>
<body>
    <%- include("../common/header" , {data}) %>
    <%- include("../common/side_bar") %>
    <div id="Popupwrap">
        <div class="Popup">           
            <span>Î°úÍ∑∏Ïù∏Ïù¥ ÌïÑÏöîÌï©ÎãàÎã§</span>
            <a href="/login"><button>ÌôïÏù∏</button> </a>
        </div>
    </div>
    <div class="page-container">
        <div class="main-content">
            <div class="club-detail-container">
                <div class="club-header">
                    <div class="club-image-container">
                        <img src="<%= club.image %>" alt="ÎèôÌò∏Ìöå Ïù¥ÎØ∏ÏßÄ" class="club-image">
                    </div>
                    <div class="club-info">
                        <div class="club-title-section">
                            <h2 class="club-name"><%= club.name %></h2>
                            <button class="btn-heart" aria-label="Ï∞úÌïòÍ∏∞">
                                <button class="btn_like <%= liked ? 'on' : '' %>" data-clubid="<%= club.club_id %>"></button>
                            </button>
                        </div>
                        <div class="club-category">
                            <span class="main-category">
                            <%= club.Category && club.Category.Parent ? club.Category.Parent.name : 'Ïπ¥ÌÖåÍ≥†Î¶¨ ÏóÜÏùå' %>
                        </span>
                        <span style="font-size: 1.2em;">‚Ä∫</span>
                        <span class="sub-category">
                            <%= club.Category ? club.Category.name : '' %>
                        </span>
                        </div>
                        
                        <div class="club-tags">
                            <% club.Tags.forEach(tag => { %>
                            <span class="tag"><%= tag.tag %></span>
                        <% }) %>
                        </div>
                        
                        <div class="club-members-count">
                            <span class="current"><%= club.Members.length %></span> /
                            <span class="max"><%= club.member_limit %></span>Î™Ö
                        </div>
                        <p class="club-description"><%= club.introduction %></p>
                        <div class="club-top-actions">
                            <% if (!isMember) { %>
                                <button type="button" id = "join_btn"  data-clubid="<%= club.club_id %>" class = "btn btn-join">Í∞ÄÏûÖ Ïã†Ï≤≠</button>
                            <% } %>
                            <% if (String(loginUserId) === String(club.creator_id)) { %>
                                <div class="club-manage-actions">
                                    
                                    <button type = "button" id = "edit_club" class="btn btn-manage">üõ†Ô∏è</button>
                                    <button type="button"  id = "add_events"class="btn btn-event-add">‚ûï</button>
                                </div>
                            <% } %>
                        </div>
                    </div>
                </div>

                <div class="club-tabs">
                    <button class="tab-btn active" data-tab="schedule">ÏùºÏ†ï</button>
                    <button class="tab-btn" data-tab="members">Î©§Î≤Ñ</button>
                    <button class="tab-btn" data-tab="reviews">Î¶¨Î∑∞</button>
                </div>
                <div class="tab-content">
                    <div class="tab-pane active" id="schedule">
                        <div class="schedule-header">
                            <h3>ÎèôÌò∏Ìöå ÏùºÏ†ï Îã¨Î†•</h3>
                        </div>
                        
                        <div id="calendar"></div>
                        <div class="schedule-detail" id="schedule-detail-modal" style="display: none;">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h3 class="modal-title"></h3>
                                    <span class="close-modal">&times;</span>
                                </div>
                                <div class="modal-body">
                                    <div class="event-info">
                                    </div>
                                    <div class="participation-poll">
                                        <h4>Ï∞∏Ïó¨ Ïó¨Î∂Ä</h4>
                                    
                                        <div class="poll-options-area"></div>
                                    
                                        <div class="participants">
                                            <div class="participant-group">
                                                <h5>Ï∞∏ÏÑù (0Î™Ö)</h5>
                                                <div class="participant-list attending"></div>
                                            </div>
                                            
                                            <div class="participant-group">
                                                <h5>Î∂àÏ∞∏ (0Î™Ö)</h5>
                                                <div class="participant-list not-attending"></div>
                                            </div>
                                            
                                            <div class="participant-group">
                                                <h5>ÎØ∏Ï†ï (0Î™Ö)</h5>
                                                <div class="participant-list maybe-attending"></div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                                            </div>
                    <div class="tab-pane" id="members">
                        <div class="members-header">
                            <h3>ÎèôÌò∏Ìöå Î©§Î≤Ñ</h3>
                        </div>
                        <div class="members-list">
                            <div class="member-group">
                                <h4>Ïö¥ÏòÅÏßÑ</h4>
                                <div class="member-cards admin-members">
                                </div>
                            </div>
                            <div class="member-group">
                                <h4>Î©§Î≤Ñ</h4>
                                <div class="member-cards regular-members">
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="tab-pane" id="reviews">
                        <div class="reviews-header">
                            <h3>ÎèôÌò∏Ìöå Î¶¨Î∑∞</h3>
                            <div class="reviews-actions">
                                <button class="btn btn-write-review">Î¶¨Î∑∞ ÏûëÏÑ±</button>
                            </div>
                        </div>
                        <div class="review-stats">
                            <div class="rating-average">
                                <div class="average-score">4.8</div>
                                <div class="stars">‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ</div>
                                <div class="review-count">Ï¥ù 15Í∞ú Î¶¨Î∑∞</div>
                            </div>
                            <div class="rating-bars">
                                <div class="rating-bar">
                                    <span class="rating-label">5Ï†ê</span>
                                    <div class="bar-container">
                                        <div class="bar" style="width: 85%;"></div>
                                    </div>
                                    <span class="rating-count">12</span>
                                </div>
                                <div class="rating-bar">
                                    <span class="rating-label">4Ï†ê</span>
                                    <div class="bar-container">
                                        <div class="bar" style="width: 12%;"></div>
                                    </div>
                                    <span class="rating-count">2</span>
                                </div>
                                <div class="rating-bar">
                                    <span class="rating-label">3Ï†ê</span>
                                    <div class="bar-container">
                                        <div class="bar" style="width: 6%;"></div>
                                    </div>
                                    <span class="rating-count">1</span>
                                </div>
                                <div class="rating-bar">
                                    <span class="rating-label">2Ï†ê</span>
                                    <div class="bar-container">
                                        <div class="bar" style="width: 0%;"></div>
                                    </div>
                                    <span class="rating-count">0</span>
                                </div>
                                <div class="rating-bar">
                                    <span class="rating-label">1Ï†ê</span>
                                    <div class="bar-container">
                                        <div class="bar" style="width: 0%;"></div>
                                    </div>
                                    <span class="rating-count">0</span>
                                </div>
                            </div>
                        </div>
                        <div class="review-form" style="display: none;">
                            <h4>Î¶¨Î∑∞ ÏûëÏÑ±</h4>
                            <div class="rating-input">
                                <span>ÌèâÏ†ê:</span>
                                <div class="star-rating">
                                    <input type="radio" id="star5" name="rating" value="5">
                                    <label for="star5">‚òÖ</label>
                                    <input type="radio" id="star4" name="rating" value="4">
                                    <label for="star4">‚òÖ</label>
                                    <input type="radio" id="star3" name="rating" value="3">
                                    <label for="star3">‚òÖ</label>
                                    <input type="radio" id="star2" name="rating" value="2">
                                    <label for="star2">‚òÖ</label>
                                    <input type="radio" id="star1" name="rating" value="1">
                                    <label for="star1">‚òÖ</label>
                                </div>
                            </div>
                            <textarea class="review-textarea" placeholder="ÎèôÌò∏Ìöå ÌôúÎèôÏóê ÎåÄÌïú ÏÜîÏßÅÌïú Î¶¨Î∑∞Î•º ÏûëÏÑ±Ìï¥Ï£ºÏÑ∏Ïöî. (ÏµúÏÜå 20Ïûê Ïù¥ÏÉÅ)"></textarea>
                            <div class="review-form-actions">
                                <button class="btn btn-cancel-review">Ï∑®ÏÜå</button>
                                <button class="btn btn-submit-review">Î¶¨Î∑∞ Îì±Î°ù</button>
                            </div>
                        </div>
                        <div class="reviews-list">
                        </div>
                    </div>
                        <div class="verification-form" style="display: none;">
                            <h4>Ï∞∏Ïó¨ Ïù∏Ï¶ù Îì±Î°ù</h4>
                            <div class="verification-event-select">
                                <label>Ïù∏Ï¶ùÌï† Î™®ÏûÑ ÏÑ†ÌÉù</label>
                                <select class="event-select">
                                    <option value="">Î™®ÏûÑÏùÑ ÏÑ†ÌÉùÌïòÏÑ∏Ïöî</option>
                                    <option value="1">2025-04-13 Ï†ïÍ∏∞ Ï∂ïÍµ¨ Î™®ÏûÑ</option>
                                    <option value="2">2025-04-20 Î≤àÍ∞ú Î™®ÏûÑ</option>
                                    <option value="3">2025-04-27 ÏõîÎ°Ä ÌöåÏãù</option>
                                </select>
                            </div>
                            
                            <div class="verification-upload-container">
                                <div class="verification-upload-box">
                                    <div class="upload-icon">üì∑</div>
                                    <p class="upload-info">ÌÅ¥Î¶≠ÌïòÏó¨ Ïù∏Ï¶ù ÏÇ¨ÏßÑÏùÑ ÏóÖÎ°úÎìúÌïòÏÑ∏Ïöî</p>
                                    <input type="file" id="verification-image" accept="image/*" style="display: none;">
                                </div>
                                <div class="verification-preview" style="display: none;">
                                    <img src="" alt="ÎØ∏Î¶¨Î≥¥Í∏∞" id="verification-preview-img">
                                    <button class="btn-remove-preview">√ó</button>
                                </div>
                            </div>
                            
                            <div class="verification-form-actions">
                                <button class="btn btn-cancel-verification">Ï∑®ÏÜå</button>
                                <button class="btn btn-submit-verification">Îì±Î°ù</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script>
        const eventList = <%- JSON.stringify(club.Events || []) %>;
        console.log(eventList);
        const userId = "<%= loginUserId %>"; 
        const isMember = <%= isMember %>; 
        const clubId = "<%= club.club_id %>";  
        console.log(isMember)
        window.reviews = <%- JSON.stringify(club.Reviews || []) %>;

        const members = <%- JSON.stringify(club.Members || []) %>;
        const ownerId = "<%= club.creator_id %>";

        const adminContainer = document.querySelector(".admin-members");
        const regularContainer = document.querySelector(".regular-members");
        const memberCountLabel = document.querySelector(".member-group h4");
        let regularCount = 0; 

        members.forEach(member => {
            const isOwner = member.user_id_fk === ownerId;
            const name = member.User?.kakao_name || "Ïù¥Î¶ÑÏóÜÏùå";
            const img = member.User?.kakao_profile_image || "https://via.placeholder.com/100";
            const joinDate = new Date(member.createdAt).toLocaleDateString('ko-KR').replaceAll('. ', '.').replace('.', '');

            const card = `
                <div class="member-card">
                    <div class="member-avatar">
                        <img src="${img}" alt="ÌîÑÎ°úÌïÑ Ïù¥ÎØ∏ÏßÄ">
                    </div>
                    <div class="member-info">
                        <h5 class="member-name">${name}</h5>
                        <span class="member-join-date">${joinDate} Í∞ÄÏûÖ</span>
                    </div>
                </div>
            `;

            if (isOwner) {
                adminContainer.insertAdjacentHTML("beforeend", card);
            } else {
                regularContainer.insertAdjacentHTML("beforeend", card);
            }
        });
        
        document.addEventListener("DOMContentLoaded", () => {
            const addBtn = document.getElementById("add_events");
            const editBtn = document.getElementById("edit_club");

            if (addBtn) {
                addBtn.addEventListener("click", () => {
                    console.log("Ïù¥Î≤§Ìä∏ Ï∂îÍ∞Ä Î≤ÑÌäº ÎàåÎ†∏Ïñ¥");
                    location.href = `/clubs/detail/${clubId}/events`; 
                });
            }

            if (editBtn) {
                editBtn.addEventListener("click", () => {
                    console.log("ÏàòÏ†ï Î≤ÑÌäº ÎàåÎ†∏Ïñ¥");
                    location.href = `/clubs/detail/${clubId}/manage`;
                });
            }
    });

    </script>
    
    <script src = "/public/script/club/detail_club.js"></script>
</body>
</html>